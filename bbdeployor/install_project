#!/bin/bash
set -e

# Get SHORTNAME from bbdeployor.conf
source bbdeployor.conf

# Ensure PostgreSQL data directory exists
mkdir -p data/postgresql

# Copy schema from data/db to data/postgresql for BBDeployor
if [ -f data/db/schema_backup.sql ]; then
    cp data/db/schema_backup.sql data/postgresql/db.sql
    echo "Database schema copied for BBDeployor initialization"
fi

# Set up environment variables for database connection
cat > .env << EOF
SECRET_KEY=your-super-secret-key
DATABASE_URL=postgresql://${SHORTNAME}:${SHORTNAME}@localhost/${SHORTNAME}
GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-your-google-client-id}
GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-your-google-client-secret}
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=${MAIL_USERNAME:-your-app-notification-email@gmail.com}
MAIL_PASSWORD=${MAIL_PASSWORD:-your-app-specific-password}
MAIL_DEFAULT_SENDER=${MAIL_DEFAULT_SENDER:-your-app-notification-email@gmail.com}
BASE_URL=https://${HOSTNAME}
EOF

# Set up nginx configuration
cat > /etc/nginx/sites-available/default << EOF
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name _;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    # Allow API endpoints to bypass HTTP Basic Auth
    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

# Reload nginx
nginx -s reload

# Create a service script
mkdir -p /etc/sv/flask-app
cat > /etc/sv/flask-app/run << EOF
#!/bin/bash
cd /var/www/${SHORTNAME}
source venv/bin/activate
export FLASK_APP=run.py
export FLASK_ENV=production
exec flask run --host=127.0.0.1
EOF

chmod +x /etc/sv/flask-app/run

# Install and start the service using BBDeployor's service manager
bbdeployor service-install /etc/sv/flask-app/run flask-app

# Set proper permissions
chown -R www-data:www-data /var/www/${SHORTNAME}

# Set up cron job for file management
chmod +x scripts/setup-cron.sh
./scripts/setup-cron.sh

# Send notification
bbdeployor message "Project installation completed for ${SHORTNAME}" 