#!/bin/bash
set -e

# This script will be called by BBDeployor when updating the project
# The first parameter indicates the update type

if [[ "$1" == "update" ]]; then
    # Pull latest changes from Git
    git pull
    
    # Install any new dependencies
    pip install --no-cache-dir -r requirements.txt
    
    # Apply database migrations
    export FLASK_APP=run.py
    flask db upgrade
    
    # Restart the Flask service
    bbdeployor service-restart flask-app
    
    # Send notification
    bbdeployor message "Project updated successfully for receiptsbonn"
elif [[ "$1" == "secrets" ]]; then
    # Handle secrets update
    if [ -f bbdeployor/secrets.zip ]; then
        # Extract .env file from secrets
        unzip -p bbdeployor/secrets.zip .env > .env
        
        # Restart the Flask service to apply new environment variables
        bbdeployor service-restart flask-app
        
        # Send notification
        bbdeployor message "Secrets updated for receiptsbonn"
    fi
fi 